<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event Tickets | Order</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="shell">
    <section class="hero">
      <span class="pill">Event Tickets</span>
      <h1>Select your event and tickets</h1>
      <p>
        Choose an event type, then pick the event and ticket quantity to complete the order.
      </p>
      <p class="note" id="customer-banner"></p>
    </section>

    <section class="card">
      <form id="order-form">
        <div class="field-group">
          <label for="event-type">Event type *</label>
          <select id="event-type" name="event_type" required>
            <option value="">Select an event type</option>
          </select>
        </div>

        <div class="field-group">
          <label for="event">Event *</label>
          <select id="event" name="event_id" required disabled>
            <option value="">Choose an event</option>
          </select>
        </div>

        <div class="field-group">
          <label for="quantity">Ticket quantity *</label>
          <input id="quantity" name="quantity" type="number" min="1" max="10" value="1" required />
        </div>

        <p class="form-status" id="order-status" role="status" aria-live="polite"></p>

        <div class="actions">
          <button class="primary" type="submit">Submit order</button>
          <a class="secondary-link" href="index.html">Back to customer form</a>
        </div>
      </form>
    </section>

    <section class="summary" id="order-summary" hidden>
      <div class="summary-card">
        <h2>Order summary</h2>
        <div class="summary-grid" id="summary-grid"></div>
        <p class="summary-total" id="summary-total"></p>
      </div>
    </section>
  </main>

  <script>
    const eventTypeSelect = document.getElementById("event-type");
    const eventSelect = document.getElementById("event");
    const orderForm = document.getElementById("order-form");
    const orderStatus = document.getElementById("order-status");
    const customerBanner = document.getElementById("customer-banner");
    const summarySection = document.getElementById("order-summary");
    const summaryGrid = document.getElementById("summary-grid");
    const summaryTotal = document.getElementById("summary-total");

    const urlParams = new URLSearchParams(window.location.search);
    const customerId = urlParams.get("customerId") || sessionStorage.getItem("customerId");
    const customerName = sessionStorage.getItem("customerName");

    if (customerName) {
      customerBanner.textContent = `Ordering tickets for ${customerName}.`;
    } else {
      customerBanner.textContent = "Ordering tickets for new customer.";
    }

    if (!customerId) {
      orderStatus.textContent = "No customer found. Please return to the customer form.";
      orderForm.querySelector("button").disabled = true;
    }

    const formatMoney = (value) => `â‚¬${Number(value).toFixed(2)}`;

    const loadEventTypes = async () => {
      try {
        const response = await fetch("/event-types");
        const types = await response.json();

        types.forEach((type) => {
          const option = document.createElement("option");
          option.value = type.id;
          option.textContent = type.event_type;
          eventTypeSelect.appendChild(option);
        });
      } catch (err) {
        orderStatus.textContent = "Unable to load event types.";
      }
    };

    const loadEvents = async (eventTypeId) => {
      eventSelect.innerHTML = "<option value=\"\">Choose an event</option>";
      eventSelect.disabled = true;

      if (!eventTypeId) {
        return;
      }

      try {
        const response = await fetch(`/events?eventTypeId=${encodeURIComponent(eventTypeId)}`);
        const events = await response.json();

        events.forEach((event) => {
          const option = document.createElement("option");
          option.value = event.id;
          option.textContent = `${event.event_name} | ${event.event_date} ${event.event_time} | ${event.location} | ${formatMoney(event.price)}`;
          eventSelect.appendChild(option);
        });

        eventSelect.disabled = events.length === 0;
        if (events.length === 0) {
          orderStatus.textContent = "No events available for that type.";
        } else {
          orderStatus.textContent = "";
        }
      } catch (err) {
        orderStatus.textContent = "Unable to load events.";
      }
    };

    eventTypeSelect.addEventListener("change", (event) => {
      loadEvents(event.target.value);
    });

    orderForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      orderStatus.textContent = "Submitting order...";

      const payload = {
        customer_id: customerId,
        event_id: eventSelect.value,
        quantity: document.getElementById("quantity").value,
      };

      try {
        const response = await fetch("/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          const error = await response.json();
          orderStatus.textContent = error.error || "Unable to submit order.";
          return;
        }

        const data = await response.json();
        const summary = data.summary;

        summaryGrid.innerHTML = "";
        const items = [
          ["Customer", `${summary.customer.first_name} ${summary.customer.last_name}`],
          ["Email", summary.customer.email],
          ["Event type", summary.event.type],
          ["Event", summary.event.name],
          ["When", `${summary.event.date} ${summary.event.time}`],
          ["Location", summary.event.location],
          ["Tickets", summary.quantity],
          ["Price per ticket", formatMoney(summary.event.price)],
        ];

        items.forEach(([label, value]) => {
          const row = document.createElement("div");
          row.className = "summary-row";
          row.innerHTML = `<span>${label}</span><strong>${value}</strong>`;
          summaryGrid.appendChild(row);
        });

        summaryTotal.textContent = `Total: ${formatMoney(summary.total)}`;
        summarySection.hidden = false;
        orderStatus.textContent = "Order complete.";
      } catch (err) {
        orderStatus.textContent = "Unable to submit order.";
      }
    });

    loadEventTypes();
  </script>
</body>
</html>
